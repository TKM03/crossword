<script>
    let userName = "";

    const crossword = [
        ['#','#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#','#', '#', '#', '#', 'N', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#','#', 'Y', 'O', 'N', 'G', 'K', 'O', 'O', 'N', '#', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#','1', 'P', '#', '#', 'E', '#', '#', '#', '#', 'P', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#','8', 'E', '#', '#', 'O', '#', '#', '#', 'H', 'E', 'R', 'I', 'T', 'A', 'G', 'E', '#', '#'],
        ['#','8', 'W', '#', '#', 'K', '#', '#', '#', '#', 'W', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#','5', 'T', '#', '#', 'F', '#', '#', '#', '#', 'T', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#','#', 'E', '#', '#', 'O', '#', '#', '#', '#', 'E', '#', '#', '#', '#', '#', '#', '#', '#'],
        ['#','#', 'R', '#', '#', 'H', '#', '#', '#', 'B', 'R', 'I', 'T', 'I', 'S', 'H', '#', '#', '#'],
        ['#','#', 'S', '#', '#', '#', '#', '#', '#', '#', '#', '#', 'A', '#', '#', '#', '#', '#', '#'], 
        ['#','#', 'M', 'A', 'L', 'A', 'Y', 'S', 'I', 'A', '#', '#', 'B', '#', '#', '#', '#', '#', '#'],
        ['#','#', 'I', '#', '#', '#', '#', '#', '#', '#', '#', '#', 'L', '#', '#', '#', '#', '#', '#'],
        ['#','#', 'T', '#', '#', '#', '#', '#', '#', '#', '#', '#', 'E', '#', '#', '#', '#', '#', '#'],
        ['#','#', 'H', '#', '#', '#', '#', '#', '#', '#', '#', '#', 'W', '#', '#', '#', '#', '#', '#'],
        ['#','#', 'I', '#', '#', '#', '#', '#', '#', '#', '#', 'T', 'A', 'N', 'K', 'A', 'R', 'D', '#'],
        ['#','#', 'N', '#', '#', '#', '#', '#', '#', '#', '#', '#', 'R', '#', '#', '#', '#', '#', '#'],
        ['#','#', 'G', '#', '#', '#', '#', '#', '#', '#', '#', '#', 'E', '#', '#', '#', '#', '#', '#'],
        ['#','#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#', '#']
    ];

    const answers = {
        horizontal: { 1: "YONGKOON", 2: "BRITISH", 3: "MALAYSIA", 4: "HERITAGE", 5: "TANKARD" },
        vertical: { 1: "NGEOKFOH", 2: "1885", 3: "PEWTER", 4: "PEWTERSMITHING", 5: "TABLEWARE" }
    };

    const numberPositions = {
        '1-horizontal': [2, 2],   // "YONGKOON"
        '2-horizontal': [8, 9],   // "BRITISH"
        '3-horizontal': [10, 2],  // "MALAYSIA"
        '4-horizontal': [4, 9],   // "HERITAGE"
        '5-horizontal': [14, 11], // "TANKARD"
        '1-vertical': [1, 5],     // "NGEOKFOH"
        '2-vertical': [3, 1],     // "1885"
        '3-vertical': [3, 10],    // "PEWTER"
        '4-vertical': [3, 2],     // "PEWTERSMITHING"
        '5-vertical': [8, 12]     // "TABLEWARE"
    };

    const preFilled = [];

    window.onload = function() {
        showNameModal();
    };

    function showNameModal() {
        const modal = document.getElementById("nameModal");
        modal.style.display = "flex";
        document.getElementById("userNameInput").focus();
    }

    function submitName() {
        const input = document.getElementById("userNameInput").value.trim();
        if (input === "") {
            alert("Please enter your name to start playing!");
            return;
        }
        userName = input;
        document.getElementById("welcome-title").textContent = `Welcome, ${userName}, to the Crossword Odyssey!`;
        document.getElementById("nameModal").style.display = "none";
        createAnswerGrid();
    }

    document.getElementById("userNameInput")?.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            submitName();
        }
    });

    function createAnswerGrid() {
        const grid = document.getElementById("answer-grid");
        grid.innerHTML = "";

        for (let row = 0; row < 18; row++) {
            for (let col = 0; col < 19; col++) {
                const cell = document.createElement("div");
                cell.classList.add("cell");
                const value = crossword[row][col];

                if (value === '#') {
                    cell.classList.add("black");
                } else {
                    let number = null;
                    for (const key in numberPositions) {
                        const [numRow, numCol] = numberPositions[key];
                        if (row === numRow && col === numCol) {
                            number = key.split('-')[0];
                            break;
                        }
                    }
                    if (number) {
                        const numberSpan = document.createElement("span");
                        numberSpan.classList.add("cell-number");
                        numberSpan.textContent = number;
                        cell.appendChild(numberSpan);
                    }
                    const input = document.createElement("input");
                    input.maxLength = 1;
                    input.dataset.row = row;
                    input.dataset.col = col;

                    const isPreFilled = preFilled.some(([r, c, v]) => r === row && c === col);
                    if (isPreFilled) {
                        const preFilledValue = preFilled.find(([r, c]) => r === row && c === col)[2];
                        input.value = preFilledValue;
                        input.disabled = true;
                    }
                    cell.appendChild(input);
                }
                grid.appendChild(cell);
            }
        }
    }

    function getWordFromGrid(startPos, length, direction) {
        const [startRow, startCol] = startPos;
        let word = "";
        for (let i = 0; i < length; i++) {
            const row = direction === "horizontal" ? startRow : startRow + i;
            const col = direction === "horizontal" ? startCol + i : startCol;
            const input = document.querySelector(`#answer-grid .cell input[data-row="${row}"][data-col="${col}"]`);
            word += input ? (input.value.toUpperCase() || "") : "";
        }
        return word;
    }

    function submitAnswers() {
        let userAnswers = {};
        let isCorrect = true;

        // Check horizontal answers
        for (let h in answers.horizontal) {
            const word = getWordFromGrid(numberPositions[`${h}-horizontal`], answers.horizontal[h].length, "horizontal");
            userAnswers[`horizontal-${h}`] = word;
            if (word !== answers.horizontal[h]) {
                isCorrect = false;
            }
        }

        // Check vertical answers
        for (let v in answers.vertical) {
            const word = getWordFromGrid(numberPositions[`${v}-vertical`], answers.vertical[v].length, "vertical");
            userAnswers[`vertical-${v}`] = word;
            if (word !== answers.vertical[v]) {
                isCorrect = false;
            }
        }

        // Format user answers for submission
        const formattedAnswers = JSON.stringify(userAnswers);

        // Google Form submission URL (corrected to formResponse)
        const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdYV1z5rhzRCQ0h1aqZMwLi6dcbKaVpSA6HCHcxlnEHki4qBg/formResponse";
        const formData = new FormData();
        formData.append("entry.315125601", userName); // Name field
        formData.append("entry.503290548", formattedAnswers); // Answers field
        formData.append("entry.728466352", isCorrect ? "Correct" : "Incorrect"); // Correctness field

        fetch(formUrl, {
            method: "POST",
            mode: "no-cors",
            body: formData
        }).then(() => {
            const container = document.getElementById("game-container");
            container.innerHTML = `
                <h1>Thank You, ${userName}!</h1>
                <p style="font-size: 18px; color: #4b5563;">Your answers have been submitted successfully. We appreciate your participation in the Crossword Odyssey!</p>
            `;
        }).catch(() => {
            alert("Submission failed. Please try again.");
        });
    }
</script>
